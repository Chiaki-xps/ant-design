# Ant Design 配置文件分析

## 📋 配置文件概览

### 配置文件分类

- **构建配置**: webpack.config.js, .antd-tools.config.js
- **文档配置**: .dumirc.ts
- **代码质量**: eslint.config.mjs, biome.json
- **测试配置**: .jest.js, jest-puppeteer.config.js
- **类型配置**: tsconfig.json, tsconfig-old-react.json
- **CI/CD**: .github/workflows/
- **其他配置**: package.json, .gitignore, .prettierrc 等

## 🔧 构建配置文件

### 1. webpack.config.js - 主要构建配置

#### 配置概览

```javascript
// 主要功能：构建 dist 文件
const getWebpackConfig = require('@ant-design/tools/lib/getWebpackConfig');
const { BundleAnalyzerPlugin } = require('webpack-bundle-analyzer');
const { codecovWebpackPlugin } = require('@codecov/webpack-plugin');
```

#### 核心功能

1. **多环境构建**: 支持开发和生产环境
2. **国际化支持**: 添加多语言包
3. **外部依赖**: 外部化 dayjs 和 cssinjs
4. **代码分析**: 集成 BundleAnalyzer
5. **代码覆盖率**: 集成 Codecov
6. **循环依赖检测**: 防止循环依赖

#### 关键函数

```javascript
// 添加国际化支持
function addLocales(config) {
  const newConfig = { ...config };
  let packageName = 'antd-with-locales';
  if (newConfig.entry['antd.min']) {
    packageName += '.min';
  }
  newConfig.entry[packageName] = './index-with-locales.js';
  newConfig.output.filename = '[name].js';
  return newConfig;
}

// 外部化 dayjs
function externalDayjs(config) {
  const newConfig = { ...config };
  newConfig.externals.dayjs = {
    root: 'dayjs',
    commonjs2: 'dayjs',
    commonjs: 'dayjs',
    amd: 'dayjs',
  };
  return newConfig;
}
```

### 2. .antd-tools.config.js - 构建工具配置

#### 配置概览

```javascript
// 主要功能：构建后的文件处理
const restCssPath = path.join(process.cwd(), 'components', 'style', 'reset.css');
const tokenStatisticPath = path.join(process.cwd(), 'components', 'version', 'token.json');
const tokenMetaPath = path.join(process.cwd(), 'components', 'version', 'token-meta.json');
```

#### 核心功能

1. **编译后处理**: 复制必要文件到输出目录
2. **分发后处理**: 处理最终分发文件
3. **Token 统计**: 处理设计 token 相关文件

## 📚 文档配置文件

### .dumirc.ts - Dumi 文档生成器配置

#### 配置概览

```typescript
export default defineConfig({
  plugins: ['dumi-plugin-color-chunk'],
  routePrefetch: {},
  manifest: {},
  conventionRoutes: {
    exclude: [/index\/components\//],
  },
  ssr: process.env.NODE_ENV === 'production' ? { builder: 'mako' } : false,
  hash: true,
  mfsu: false,
  mako: ['Darwin', 'Linux'].includes(os.type()) ? {} : false,
  crossorigin: {},
  runtimePublicPath: {},
  outputPath: '_site',
});
```

#### 核心功能

1. **多语言支持**: 中英文文档
2. **路由配置**: 自动生成路由
3. **构建优化**: SSR、MFSU、Mako
4. **路径别名**: 组件库路径映射
5. **插件集成**: 自定义插件

#### 路径别名配置

```typescript
alias: {
  'antd/lib': path.join(__dirname, 'components'),
  'antd/es': path.join(__dirname, 'components'),
  'antd/locale': path.join(__dirname, 'components/locale'),
  antd: path.join(__dirname, 'components'),
  '@ant-design/icons$': '@ant-design/icons/lib',
},
```

## 🛠️ 代码质量配置

### 1. eslint.config.mjs - ESLint 配置

#### 配置概览

```javascript
export default antfu(
  {
    ignores: [
      '**/node_modules/**',
      '**/dist/**',
      '**/_site/**',
      '**/es/**',
      '**/lib/**',
      '**/.dumi/tmp/**',
      '**/.dumi/tmp-production/**',
      '**/*.snap',
      '**/*.md',
      '.dumi/scripts/clarity.js',
    ],
    settings: {
      polyfills: ['Promise', 'URL'],
    },
    type: 'lib',
    stylistic: false,
    typescript: true,
    react: true,
  },
  // 其他配置...
);
```

#### 核心功能

1. **基础配置**: 使用 antfu 预设
2. **TypeScript 支持**: 完整的 TS 规则
3. **React 支持**: React 和 React Hooks 规则
4. **可访问性**: jsx-a11y 规则
5. **兼容性**: compat 插件
6. **测试支持**: Jest 规则

### 2. biome.json - Biome 代码格式化配置

#### 配置概览

```json
{
  "$schema": "./node_modules/@biomejs/biome/configuration_schema.json",
  "files": {
    "ignoreUnknown": true,
    "includes": ["**", "!.dumi/tmp*", "!dist/*", "!es/**/*", "!lib/**/*"]
  },
  "formatter": {
    "enabled": true,
    "indentStyle": "space",
    "lineWidth": 100,
    "indentWidth": 2
  },
  "javascript": {
    "jsxRuntime": "reactClassic",
    "formatter": {
      "quoteStyle": "single"
    }
  }
}
```

#### 核心功能

1. **代码格式化**: 统一的代码风格
2. **Linting**: 代码质量检查
3. **文件过滤**: 排除不需要处理的文件
4. **规则配置**: 自定义 linting 规则

## 🧪 测试配置文件

### .jest.js - Jest 测试配置

#### 配置概览

```javascript
module.exports = {
  verbose: true,
  testEnvironment: 'jsdom',
  setupFiles: ['./tests/setup.ts', 'jest-canvas-mock'],
  setupFilesAfterEnv: ['./tests/setupAfterEnv.ts'],
  moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json', 'md'],
  modulePathIgnorePatterns: ['/_site/'],
  moduleNameMapper: {
    '/\\.(css|less)$/': 'identity-obj-proxy',
    '^antd$': '<rootDir>/components/index',
    '^antd/es/(.*)$': '<rootDir>/components/$1',
    '^antd/lib/(.*)$': '<rootDir>/components/$1',
    '^antd/locale/(.*)$': '<rootDir>/components/locale/$1',
  },
};
```

#### 核心功能

1. **测试环境**: jsdom 环境
2. **模块映射**: 路径别名支持
3. **文件转换**: TypeScript、Markdown 等
4. **覆盖率收集**: 详细的覆盖率配置
5. **并行执行**: 多进程测试

#### 模块映射配置

```javascript
moduleNameMapper: {
  // 样式文件处理
  '/\\.(css|less)$/': 'identity-obj-proxy',

  // 组件库路径映射
  '^antd$': '<rootDir>/components/index',
  '^antd/es/(.*)$': '<rootDir>/components/$1',
  '^antd/lib/(.*)$': '<rootDir>/components/$1',
  '^antd/locale/(.*)$': '<rootDir>/components/locale/$1',
},
```

## 🔄 CI/CD 配置文件

### .github/workflows/test.yml - GitHub Actions 测试配置

#### 配置概览

```yaml
name: ✅ test

on:
  push:
    branches: [master, feature]
  pull_request:
    branches: [master, feature]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
```

#### 核心功能

1. **多环境测试**: React 16/17/18 版本测试
2. **并行执行**: 分片测试提高效率
3. **覆盖率收集**: 自动收集和上传覆盖率
4. **构建验证**: 验证构建产物
5. **并发控制**: 避免重复执行

#### 测试矩阵配置

```yaml
test-react-legacy:
  name: test-react-legacy
  strategy:
    matrix:
      react: ['16', '17']
      shard: [1/2, 2/2]
  env:
    REACT: ${{ matrix.react }}
```

## 📝 其他重要配置

### 1. package.json - 项目配置

#### 关键字段

```json
{
  "name": "antd",
  "version": "5.27.1",
  "main": "lib/index.js",
  "module": "es/index.js",
  "unpkg": "dist/antd.min.js",
  "typings": "es/index.d.ts",
  "sideEffects": ["*.css"],
  "files": ["BUG_VERSIONS.json", "dist", "es", "lib", "locale"]
}
```

#### 重要脚本

```json
{
  "scripts": {
    "build": "npm run compile && cross-env NODE_OPTIONS='--max-old-space-size=4096' npm run dist",
    "compile": "npm run clean && antd-tools run compile",
    "dist": "antd-tools run dist",
    "test": "jest --config .jest.js --no-cache",
    "lint": "npm run version && npm run tsc && npm run lint:script && npm run lint:biome && npm run lint:md && npm run lint:style && npm run lint:changelog",
    "start": "tsx ./scripts/set-node-options.ts cross-env PORT=8001 dumi dev"
  }
}
```

### 2. tsconfig.json - TypeScript 配置

#### 核心配置

```json
{
  "compilerOptions": {
    "target": "es6",
    "jsx": "react",
    "jsxFactory": "React.createElement",
    "jsxFragmentFactory": "React.Fragment",
    "lib": ["dom", "es2017"],
    "experimentalDecorators": true,
    "baseUrl": "./",
    "module": "esnext",
    "moduleResolution": "Bundler",
    "strict": true,
    "strictNullChecks": true,
    "noImplicitAny": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "stripInternal": true,
    "esModuleInterop": true,
    "skipLibCheck": true
  }
}
```

#### 路径映射

```json
{
  "paths": {
    "@@/*": [".dumi/tmp/*"],
    "antd": ["components/index.ts"],
    "antd/es/*": ["components/*"],
    "antd/lib/*": ["components/*"],
    "antd/locale/*": ["components/locale/*"]
  }
}
```

## 🎯 配置最佳实践

### 1. 构建优化

- **多入口配置**: 支持不同格式的输出
- **外部依赖**: 减少打包体积
- **代码分割**: 按需加载
- **缓存优化**: 提高构建速度

### 2. 代码质量

- **统一规范**: ESLint + Biome 双重保障
- **类型安全**: 严格的 TypeScript 配置
- **自动修复**: 支持自动格式化
- **规则定制**: 根据项目需求调整

### 3. 测试策略

- **多环境测试**: 确保兼容性
- **并行执行**: 提高测试效率
- **覆盖率监控**: 保证代码质量
- **持续集成**: 自动化测试流程

### 4. 文档管理

- **多语言支持**: 中英文文档
- **自动生成**: 基于源码生成文档
- **版本管理**: 支持多版本文档
- **SEO 优化**: 搜索引擎友好

---

**总结**: Ant Design 的配置文件体系非常完善，涵盖了构建、测试、代码质量、文档生成等各个方面，体现了企业级项目的工程化水平。通过学习和理解这些配置，可以掌握现代前端项目的工程化最佳实践。
